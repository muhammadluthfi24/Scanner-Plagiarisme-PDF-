<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Plagiarisme PDF Modul â€” Fixed</title>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
        // IMPORTANT: set the workerSrc so pdf.js can parse files reliably
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
    </script>

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Montserrat:wght@500;700&display=swap"
        rel="stylesheet">

    <link rel="icon" type="image/png" href="assets/img/be8e566c8681ff703c922c55b60d9f28.png">
    <style>
        body {
            background: #f4f4f4;
            font-family: 'Poppins', sans-serif;
        }

        .card {
            border-radius: 12px;
        }

        pre.small {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 12px;
        }

        .muted-small {
            font-size: 13px;
            color: #6c757d;
        }
    </style>
</head>

<body>

    <div class="container py-5">

        <div class="card shadow p-4">
            <h2 class="text-center">ðŸ“„ Scanner Plagiarisme PDF â€” Fixed</h2>

            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Pilih Modul</label>
                    <select id="modul" class="form-select">
                        <option value="" selected disabled>Pilih Modul</option>
                    </select>
                </div>

                <div class="col-md-8">
                    <label class="form-label fw-bold">Upload File PDF (Maks 36 orang)</label>
                    <input type="file" id="pdfInput" class="form-control" accept="application/pdf" multiple>
                    <div class="muted-small mt-1">Tip: jika file adalah hasil scan (gambar) â€” teks akan kosong. Gunakan OCR terlebih
                        dahulu.</div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" id="startBtn">Mulai Scan</button>
            </div>

            <div id="status" class="mt-3"></div>

            <div id="resultSection" class="mt-4"></div>
        </div>

    </div>

    <footer style="background:#1c1c1c; color:#ddd; padding:30px 0; font-family:'Poppins', sans-serif; margin-top:30px;">

        <div class="container">
            <div class="row">

                <div class="col-md-4 mb-3">
                    <h4 style="font-family:'Montserrat', sans-serif; font-weight:700; color:#fff;">Scanner Plagiarisme PDF</h4>
                    <p style="line-height:1.6; margin-top:10px; color:#bbb;">Sistem pengecekan kemiripan otomatis untuk modul mahasiswa. Cepat
                        dan sederhana â€” cocok untuk pemeriksaan awal.</p>
                </div>

                <div class="col-md-2 mb-3">
                    <h6 class="fw-bold mb-2" style="color:#fff;">Tentang</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" style="color:#bbb; text-decoration:none;">Tentang Aplikasi</a></li>
                        <li><a href="#" style="color:#bbb; text-decoration:none;">Developer</a></li>
                    </ul>
                </div>

                <div class="col-md-2 mb-3">
                    <h6 class="fw-bold mb-2" style="color:#fff;">Fitur</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" style="color:#bbb; text-decoration:none;">Upload PDF</a></li>
                        <li><a href="#" style="color:#bbb; text-decoration:none;">Deteksi</a></li>
                    </ul>
                </div>

                <div class="col-md-2 mb-3">
                    <h6 class="fw-bold mb-2" style="color:#fff;">Bantuan</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" style="color:#bbb; text-decoration:none;">FAQ</a></li>
                    </ul>
                </div>

                <div class="col-md-2 mb-3 text-end">
                    <p style="margin:0; font-family:'Montserrat', sans-serif; font-size:15px; color:#fff;">Â© Ngoding Happy 2025
                    </p>
                    <small style="color:#bbb;">Dikelola oleh <b>ngodinghappy</b> â€¢ Pemilik: <b>Muhammad Luthfi
                            Farizqi</b></small>
                </div>

            </div>
        </div>
    </footer>


    <script>
        // populate modul select
        (function populateModules() {
            const sel = document.getElementById('modul');
            for (let i = 1; i <= 14; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = 'Modul ' + i;
                sel.appendChild(opt);
            }
        })();

        // ============================
        // BACA PDF â†’ RETURN TEXT
        // ============================
        async function readPDF(file, onProgress) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;

                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + ' ';
                    if (onProgress) onProgress(i, pdf.numPages);
                }

                return text.trim();
            } catch (err) {
                console.error('readPDF error', err);
                return null; // indicate failure
            }
        }

        // =================================
        // HITUNG SIMILARITY (Cosine) â€” improved tokenization
        // =================================
        function tokenize(s) {
            return s
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .split(/\s+/)
                .filter(Boolean);
        }

        function similarity(a, b) {
            const wordsA = tokenize(a);
            const wordsB = tokenize(b);

            if (wordsA.length === 0 || wordsB.length === 0) return 0;

            const freqA = {};
            const freqB = {};

            for (const w of wordsA) freqA[w] = (freqA[w] || 0) + 1;
            for (const w of wordsB) freqB[w] = (freqB[w] || 0) + 1;

            const all = new Set([...Object.keys(freqA), ...Object.keys(freqB)]);
            let dot = 0, magA = 0, magB = 0;
            for (const w of all) {
                const va = freqA[w] || 0;
                const vb = freqB[w] || 0;
                dot += va * vb;
                magA += va * va;
                magB += vb * vb;
            }
            magA = Math.sqrt(magA);
            magB = Math.sqrt(magB);
            return (dot / (magA * magB)) * 100 || 0;
        }

        function getGrade(score) {
            if (score > 80) return 'A';
            if (score >= 65) return 'B';
            if (score >= 40) return 'C';
            return 'D';
        }

        // =================================
        // MAIN PROCESS
        // =================================
        document.getElementById('startBtn').addEventListener('click', processPDFs);

        async function processPDFs() {
            const files = Array.from(document.getElementById('pdfInput').files);
            const resultSection = document.getElementById('resultSection');
            const status = document.getElementById('status');

            resultSection.innerHTML = '';
            status.innerHTML = '';

            if (!files.length) {
                alert('Upload minimal 2 PDF!');
                return;
            }
            if (files.length > 36) {
                alert('Max 36 orang per modul!');
                return;
            }

            // show initial status
            status.innerHTML = `<div class="alert alert-info">Memproses ${files.length} file... <small id="subStatus"></small></div>`;
            const subStatus = document.getElementById('subStatus');

            // read files sequentially but non-blocking UI
            const extracted = [];

            for (let idx = 0; idx < files.length; idx++) {
                const file = files[idx];
                subStatus.textContent = `Membaca ${file.name} (${idx + 1}/${files.length})`;

                const text = await readPDF(file, (page, total) => {
                    subStatus.textContent = `Membaca ${file.name}: halaman ${page}/${total}`;
                });

                if (text === null) {
                    extracted.push({ name: file.name, text: '', error: true });
                } else {
                    extracted.push({ name: file.name, text, error: false });
                }
            }

            // compute similarities
            // prepare table
            let highest = { name: '', score: 0 };

            let html = `
        <div class="card shadow p-3">
            <h3 class="text-center">ðŸ“Š Hasil Scan Plagiarisme PDF</h3>
            <div class="table-responsive mt-3">
            <table class="table table-bordered table-sm align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Nama File</th>
                        <th>Kesamaan Tertinggi</th>
                        <th>Plagiat Dengan</th>
                        <th>Nilai</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

            for (let i = 0; i < extracted.length; i++) {
                const A = extracted[i];
                let maxSim = 0;
                let plagWith = '-';

                if (A.error) {
                    html += `<tr><td>${A.name}</td><td>-</td><td>-</td><td>-</td><td><span class="text-danger">Gagal baca PDF</span></td></tr>`;
                    continue;
                }

                if ((A.text || '').length < 30) {
                    // very short text â€” probably image-only pdf
                    html += `<tr>
                        <td>${A.name}</td>
                        <td>0%</td>
                        <td>-</td>
                        <td>-</td>
                        <td><span class="text-warning">Teks sedikit / image-only (gunakan OCR)</span></td>
                    </tr>`;
                    continue;
                }

                for (let j = 0; j < extracted.length; j++) {
                    if (i === j) continue;
                    const B = extracted[j];
                    if (B.error || (B.text || '').length < 30) continue;

                    const sim = similarity(A.text, B.text);
                    if (sim > maxSim) {
                        maxSim = sim;
                        plagWith = B.name;
                    }
                }

                if (maxSim > highest.score) highest = { name: A.name, score: maxSim };

                const grade = getGrade(100 - maxSim); // grade based on dissimilarity

                html += `
                <tr>
                    <td>${A.name}</td>
                    <td>${maxSim.toFixed(2)}%</td>
                    <td>${plagWith}</td>
                    <td>${grade}</td>
                    <td><small class="text-muted">Panjang teks: ${A.text.length} chars</small></td>
                </tr>`;
            }

            html += `
                </tbody>
            </table>
            </div>

            <div class="mt-3">
                <div class="alert alert-${highest.score >= 30 ? 'danger' : 'secondary'}">
                    ðŸ”¥ <b>Paling Tinggi Kemiripan:</b> ${highest.name || '-'} <b>(${highest.score.toFixed(2)}%)</b>
                </div>

                <div class="small text-muted">Catatan: Jika file merupakan hasil scan gambar (foto atau scan tanpa OCR), teks tidak akan
                    terbaca. Gunakan aplikasi OCR (contoh: Google Drive OCR, Tesseract) untuk mengekstrak teks sebelum
                    meng-upload.</div>
            </div>
        </div>`;

            resultSection.innerHTML = html;
            status.innerHTML = `<div class="alert alert-success">Selesai memproses ${files.length} file.</div>`;

            // scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>

</body>

</html>